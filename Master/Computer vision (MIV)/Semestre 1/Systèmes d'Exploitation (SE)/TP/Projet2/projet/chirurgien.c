#include "commun.h"

void envoyer_tube(const char *fifo, struct imp_msg mess2) {
    int fd = open(fifo, O_WRONLY);
    if (fd == -1) {
        perror("open fifo write");
    } else {
        struct tube_msg tm;
        tm.type_malade = mess2.type_malade;
        tm.num_malade = mess2.num_malade;
        tm.num_organe = mess2.num_organe;
        write(fd, &tm, sizeof(tm));
        close(fd);
        
        if (mess2.type_malade == 1) {
            printf("[Chirurgien]: DONNEUR reçoit commande : malade CRITIQUE %d veut organe N:%d\n",mess2.num_malade,mess2.num_organe);

        } else if (mess2.type_malade == 2) {
            printf("[Chirurgien]: DONNEUR reçoit commande : malade NON-CRITIQUE %d veut organe N:%d\n",mess2.num_malade,mess2.num_organe);
        }

    }
}

void prelever(int shmid, struct imp_msg *mess2) {
    
    struct Tampon *tampon = (struct Tampon *) shmat(shmid, NULL, 0);
    if (tampon == (void *) -1) {
        perror("shmat");
        return;
    }
    
    int head = tampon->head;
    
    mess2->type_malade = tampon->organes[head].type_malade;
    mess2->num_malade = tampon->organes[head].num_malade;
    mess2->num_organe = tampon->organes[head].num_organe;
    
    tampon->head = (head + 1) % N;
    
    shmdt(tampon);
}

void envoyer_qimp(int qimp, struct imp_msg mess2) {
    mess2.mtype = 1;

    if (msgsnd(qimp, &mess2, sizeof(struct imp_msg) - sizeof(long), 0) == -1) {
        perror("msgsnd qimp");
    } else {
        if (mess2.type_malade == 1) {

            //printf("[Chirurgien]: IMPLANTATION : organe N:%d implante pour patient CRITIQUE %d\n",mess2.num_organe, mess2.num_malade);
            printf("[Chirurgien]: Patient CRITIQUE %d → Transplantation de l'organe N:%d reussie !\n",mess2.num_malade, mess2.num_organe);

        } else {

            //printf("[Chirurgien]: IMPLANTATION : organe N:%d implante pour patient NON-CRITIQUE %d\n", mess2.num_organe, mess2.num_malade);
            printf("[Chirurgien]: Patient NON-CRITIQUE %d → Transplantation de l'organe N:%d reussie !\n", mess2.num_malade, mess2.num_organe);
        }
    }
}


int recuvoir(int qid, struct req_msg *mess1) {
    return msgrcv(qid, mess1, sizeof(struct req_msg) - sizeof(long), 0, IPC_NOWAIT);
}

int main(){
    srand(time(NULL) ^ getpid());

    key_t k_qcr = ftok(FTOK_PATH, 'A');
    key_t k_qncr = ftok(FTOK_PATH, 'B');
    key_t k_qimp = ftok(FTOK_PATH, 'C');
    key_t k_sem = ftok(FTOK_PATH, 'D');
    key_t k_shm = ftok(FTOK_PATH, 'E');

    int qcr = msgget(k_qcr, 0666);
    int qncr = msgget(k_qncr, 0666);
    int qimp = msgget(k_qimp, 0666);

    int semid = semget(k_sem, 2, 0666);
    int shmid = shmget(k_shm, sizeof(struct Tampon), 0666);
    
    if(qcr==-1||qncr==-1||qimp==-1||semid==-1||shmid==-1){
        perror("chirurgien ipc");
        exit(1);
    }

    const char *fifo = "/tmp/tube_tp2";

    struct req_msg mess1;
    struct imp_msg mess2;
    
    int i1 =0;
    int i2 =0;
    int nb_rep = 0;

    printf("Chirurgien demarre (ecoute requêtes)...\n");

    while(nb_rep < M1+M2){
        // Partie 1 : Reception des demandes des malades
        if(i1 < M1 && recuvoir(qcr, &mess1) != -1) {
            i1++;
            
            printf("[Chirurgien]:URGENCE - Patient critique %d demande Organe N:%d\n", mess1.num_malade, mess1.num_organe);
            
            mess2.type_malade = 1;
            mess2.num_malade = mess1.num_malade;
            mess2.num_organe = mess1.num_organe;

            envoyer_tube(fifo , mess2);
        } 

        if(i2 < M2 && recuvoir(qncr, &mess1) != -1) {
            i2++;

            printf("[Chirurgien]:malade NON CRITIQUE %d demande Organe N:%d\n", mess1.num_malade, mess1.num_organe);
            
            mess2.type_malade = 2;
            mess2.num_malade = mess1.num_malade;
            mess2.num_organe = mess1.num_organe;
            
            envoyer_tube(fifo , mess2);
        }
    
        // Partie 2 : prelever des organes de tanpom de donnees partage
        P(semid, MUTEX_SEM);
        
        struct Tampon *tampon = (struct Tampon*)shmat(shmid, NULL, 0);
        if(tampon == (void*) -1){ 
            perror("shmat"); 
            V(semid, MUTEX_SEM);
            continue;
        }
        
        int count = tampon->count;

        if(count > 0){
            V(semid, MUTEX_SEM);
            prelever(shmid, &mess2);

            P(semid, MUTEX_SEM);
            tampon->count = tampon->count - 1;   // decrement cpt
            shmdt(tampon);
            V(semid, MUTEX_SEM);
            V(semid, EMPTY_SEM);

            envoyer_qimp(qimp, mess2);
            nb_rep++;

        } else {
            shmdt(tampon);
            V(semid, MUTEX_SEM);
            usleep(200000); // Attendre 0.2 seconde
        }
    }

    printf("Resume: %d transplantations critiques et non-critiques reussies !\n",nb_rep);
    printf("Tous les malades sont satisfaits.\n");
    return 0;
}