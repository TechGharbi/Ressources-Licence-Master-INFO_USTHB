#include "commun.h"
int Agenerer () {
    // int r = rand() % 2;
    // return (r == 0);
    return 1;
}

int recuvoir(int qimp, struct imp_msg *mess2){
    return msgrcv(qimp, mess2, sizeof(struct imp_msg) - sizeof(long), 0, IPC_NOWAIT);
}

int envoyer(int qcr, struct req_msg mess1){
    mess1.mtype = 1;
    return msgsnd(qcr, &mess1, sizeof(struct req_msg)-sizeof(long), 0);
}

void enregistre(struct req_msg *liste,struct req_msg mess1){
    liste[mess1.num_malade -1]= mess1 ;
    printf("[Malade CRITIQUE]: Enregistrement pour malade %d (organe: %d)\n", mess1.num_malade, mess1.num_organe);
}

int supprimer(struct req_msg *liste, struct imp_msg mess2) {
    int trouve = 0;
    for (int k = 0; k < M1; k++) {
        if (liste[k].num_malade == mess2.num_malade) {
            liste[k].num_malade = 0; 
            liste[k].num_organe = 0;
            trouve = 1;
            break;
        }
    }
    return trouve;
}

int main(){
    srand(time(NULL) ^ getpid());

    key_t k_qcr = ftok(FTOK_PATH, 'A');
    key_t k_qimp = ftok(FTOK_PATH, 'C');

    int qcr = msgget(k_qcr, 0666);
    int qimp = msgget(k_qimp, 0666);

    if(qcr == -1 || qimp == -1){
        perror("malade_critique msgget");
        exit(1);
    }

    printf("Malade CRITIQUE démarré \n");

    struct req_msg liste_locale[M1] = {0} ;
    int i = 0; 
    int nb_rep = 0; 
    struct req_msg mess1;
    struct imp_msg mess2;

    while(nb_rep < M1){
        // Partie 1: Génération et envoi des demandes
        while(i < M1 && Agenerer()){
            
            i++;
            int j = (rand() % N1) + 1; 
            
            mess1.mtype = 1;
            mess1.num_malade = i; 
            mess1.num_organe = j;

            if(envoyer(qcr,mess1) == -1){
                perror("msgsnd qcr");
            } else {
                printf("[Malade CRITIQUE]: %d demande Organe N:%d \n", i, j);
            }
            
            enregistre(liste_locale, mess1);
        }
    
        // Partie 2: Réception des organes implantés
        if(recuvoir(qimp,&mess2) != -1){
            
            if(mess2.type_malade == 1){
                //printf("[Malade CRITIQUE]:IMPLANTATION : Organe N:%d implanté pour patient %d\n",mess2.num_organe, mess2.num_malade);
                printf("[Malade CRITIQUE]: %d → Transplantation de Organe N:%d réussie !\n",mess2.num_malade, mess2.num_organe);
                
                supprimer(liste_locale, mess2);
                nb_rep++;
            } 
        }
        // Petite pause pour eviter une boucle trop rapide
        usleep(100000);
    }
    printf("[Malade CRITIQUE]: Tous les malades critiques sont traités (%d transplantations)\n", nb_rep);
    return 0;
}
